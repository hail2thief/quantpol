---
title: "Wrangling II"
subtitle: "The Scientific Study of Politics"  
author: 
  - "Juan Tellez"
date: '`r Sys.Date()`'
output:
  xaringan::moon_reader:
    lib_dir: "libs"
    css: ["default", "css/my-theme.css", "css/ath-inferno-fonts.css"]
    seal: false
    nature:
      highlightStyle: github
      highlightLanguage: ["r"]
      highlightLines: true
      highlightSpans: true
      countIncrementalSlides: false
      ratio: "16:9"
      navigation:
        scroll: false
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
knitr::opts_chunk$set(
  fig.width=9, 
  fig.height=3.5, 
  fig.retina=3,
  out.width = "100%",
  cache = FALSE,
  echo = FALSE,
  message = FALSE, 
  warning = FALSE,
  hiline = TRUE
)
```



```{r packages}
library(tidyverse)
library(socviz)

# dubois colors
red = "#dc354a"
yellow = "ecb025"
blue = "#213772"


# elections
elections = read_csv("../files/elections.csv")


```



class: left, middle
background-image: url("images/dubois-spiral-2.png")
background-position: right
background-size: contain

# `r rmarkdown::metadata$title`

### *`r rmarkdown::metadata$subtitle`*

### Professor `r rmarkdown::metadata$author` 

#### University of California, Davis

---

class: center
.large[
# Today's agenda
]

--
.box-1.large.sp-after[Making amends]

--
.box-2.large.sp-after[Mutating new variables]

--
.box-3.large.sp-after[Creating categories]

---

class: center, middle
# Weekly check-in

So far, you: 

--

somehow do not know how to make every graph from scratch based solely off memory

--

are confused about errors you are seeing for the first time in a computer program you've never used before

--

are unable to re-type all the code I am presenting on slides into your notes at what would be a rate on par with a professional court stenographer


---

# And yet...


```{r}
knitr::include_graphics("images/ps1-grades.png")
```


---

class: center, middle
# Weekly check-in


You are *confused* and *unsure* of yourselves

--

But you are doing **well**

--

You've only been coding for two weeks

--

You just need to know how to piece together answers from notes + slides

--

You will **slowly** get better at coding, and dealing with errors (be patient!)


---

class: middle
background-image: url("images/buddha.jpeg")
background-position: center
background-size: cover
# Please calm down

---


# The logical operators


```{r,echo = FALSE}
tribble(~Operator, ~meaning,
        "==", "equal to",
        "!=", "not equal to",
        ">", "greater than",
        "<", "less than",
        ">=", "greater than or equal to",
        "<=", "less than or equal to",
        "&", "AND (both conditions true)",
        "|", "OR (either condition is true)") %>%
  knitr::kable(align = "cc")
```


---

# 🚨 Your turn: again 🚨

Using `elections`:

.small[
1. Find the worst place I've lived: Trump won with more than 53% of the vote, median income is less than $45,000, either in the South or the Northeast, and the population is between 155k and 156k. What county is it?


2. Which counties in the South have more than 1 million inhabitants? Make a barplot of the population of these.

3. Which counties in California did Romney beat Obama *by more than 20 percentage points*? Make a plot of your choosing about these counties.
]

```{r}
countdown::countdown(minutes = 5L)
```

---

# Breaking (3) down: the puzzle

> Which counties in California did Romney beat Obama *by more than 20 percentage points*? Make a plot of your choosing about these counties.

Can be overwhelming at first but think about it in "chunks": 

--

1. Counties in California...

--

2. ...Romney beat Obama

--

3. ...By more than 20 points


---


# Breaking (3) down: the data


```{r, echo = TRUE}
elections
```

---

# Breaking (3) down: counties in California


```{r, echo = TRUE}
elections %>%
  filter(state == "CA") #<<
```

---

# Breaking (3) down: where Romney beat Obama

```{r, echo = TRUE}
elections %>%
  filter(state == "CA") %>%
  filter(per_gop_2012 > per_dem_2012) #<<
```

---

# Breaking (3) down: by more than 20 points...


Tricky!

```{r, echo = TRUE}
elections %>%
  filter(state == "CA") %>%
  filter(per_gop_2012 - per_dem_2012 > .2) #<<
```

---

# Breaking (3) down: store as an object

```{r, echo = TRUE}
romney_ca = elections %>% #<<
  filter(state == "CA") %>%
  filter(per_gop_2012 - per_dem_2012 > .2)
```


--

Storing objects is very important! The original `elections` dataset remains unchanged!


```{r, echo = TRUE}
elections
```



---


# Breaking (3) down: make the plot


```{r, echo = TRUE, out.width="80%"}
ggplot(romney_ca, aes(x = name, y = per_gop_2012)) +
  geom_col() + coord_flip() +
  labs(y = "2012 GOP vote share (%)", x = "County") + theme_light()
```


---


# The formula

--

- *Wrangle* the data until you're satisfied with the output:

```{r, echo = TRUE, eval = FALSE}
apples %>%
  filter(sweet == FALSE) %>% filter(pounds < 2)
```


--


- Store the output as a new object:

```{r, echo = TRUE, eval = FALSE}
sour_apples = apples %>% #<<
  filter(sweet == FALSE) %>% filter(pounds < 2)
```


--

- Use the new object (e.g., plotting):

```{r, echo = TRUE, eval = FALSE}
ggplot(sour_apples, aes(x = name, y = pounds)) + geom_col()
```


---


class: center, middle
# Making new variables with `mutate()`


`mutate()` **adds** new variables to data


```{r, out.width="60%"}
knitr::include_graphics("images/mutate.png")
```

---

# Using mutate


Say I want a new variable that gives me the apple weight in **pounds**


```{r}
apples = tribble(~name, ~color, ~pounds, ~sweet,
        "Fuji", "red", 2, TRUE,
        "Gala", "green", 4, TRUE,
        "Macintosh", "green", 8, FALSE,
        "Granny Smith", "red", 3, FALSE)


apples %>% knitr::kable()
```

???
How to convert pounds to ounces
---

# Create an "ounces" variable

```{r,echo = TRUE}
apples %>%
  mutate() #<<
```


---

# Create an "ounces" variable

--

The new variable, ounces, is going to equal *pounds* multiplied by 16 (16 oz in a pound)


--


```{r,echo = TRUE, eval = TRUE}
apples %>%
  mutate(ounces = pounds * 16) #<<
```


---

# Another example: population density


Say I want to know how **densely** populated all counties in the US are:


```{r}
elections %>%
  select(name, state, pop, land_area) %>% 
  head() %>% 
  knitr::kable()
```

---

# Density

$Density = \frac{Population}{Area}$

--


```{r, echo = TRUE, eval = FALSE}
elections %>%
  mutate(density = pop / land_area) #<<
```


```{r}
elections %>%
  mutate(density = pop / land_area) %>% 
  select(name, state, pop, land_area, density)
```


---


# Save your work!


```{r, echo = TRUE}
elections_density = elections %>%
  mutate(density = pop / land_area)
```

--

Notice that the original `elections` does not have this new variable!


```{r, echo = TRUE}
elections %>% names()
```

---


# Population density and vote choice


Do denser counties tend to vote more R or D?

--

```{r, echo = TRUE, out.width="70%"}
ggplot(elections_density, aes(x = density, y = per_gop_2020)) +
  geom_point() + labs(x = "Pop density", y = "GOP vote share (2020)") + theme_minimal()
```

???
Looks horrible --> density is very skewed

---


# Dealing with the skew with logarithms


Sometimes it is appropriate to take the natural logarithm of a highly-skewed variable (don't stress about this)

--

Mutate our new dataset, `elections_density`

```{r, echo = TRUE}
log_elec_density = elections_density %>%
  mutate(log_density = log(density)) #<<
```

--


Another approach, mutating the original `elections` dataset *twice*


```{r, echo = TRUE}
log_elec_density = elections %>%
  mutate(density = pop / land_area) %>% 
  mutate(log_density = log(density)) #<<
```

---


# Plot again 🧘‍♂️


```{r, echo = TRUE, out.width="70%"}
ggplot(log_elec_density, aes(x = log_density, y = per_gop_2020)) + 
  geom_point() + labs(x = "Pop density (logged)", y = "GOP vote share (2020)") + 
  theme_light()
```

---


# Math on computers


```{r}
tribble(~Math, ~Keyboard, 
        "Add", "`+`",
        "Subtract", "`-`",
        "Multiply", "`*`",
        "Divide", "`/`") %>% 
  knitr::kable()
```



---

# 🚨 Your turn: using `elections` 🚨

--

.small[
1. Create a variable that tells you how densely populated the county is. What's the least and most densely populated county?

2. Construct a variable that tells you the percent of the population in a county that is neither Black nor white (so: other race/ethnic groups). Make a plot of some kind with this data.

3. Using either `elections` or `flights` make a plot of something you're interested in! Ideally uses `filter` and `mutate` but not necessary. Post it on the Slack so we can see.  

4. 🔥Challenge🔥: Create a variable that tells you whether a county **flipped** from 2016 to 2020 (e.g., Dems won it in 2016, Reps won it in 2020). 
]

```{r}
countdown::countdown(minutes = 10L)
```


---

# Back to the weekly check-in


- UGH: `ggplot()` or ` %>% ` or whatever not found

--

- where is my .rmd file?

--

- trouble remembering what goes in `aes()` versus gets added on as a layer

--

- Where are the library datasets coming from? The internet? 

--

- do you need to add `data = ` to ggplot?

---


class: center, middle, inverse
# Creating categories
---


# Creating categories with `case_when()`

Sometimes we want to create **categorical variables** (tall, short, poor, rich, Republican-leaning, Democrat-leaning, etc.)

We can use `case_when()`, a special function that goes **within** mutate

Like `filter()`, `case_when()` also relies on logical operators

---

# Who won the election?

```{r}
elections %>% 
  select(name, state, per_gop_2020, per_dem_2020) %>% 
  head()
```

---


# Who won the election?

Let's say we want to break down elections into four categories: 

- places where R's won **big** (let's say big = more than 10 points)
- places where R's won *small* (from winning at all up to 10 points)
- places where R's lost **big** (let's say big = more than 10 points)
- places where R's lost *small* (from winning at all up to 10 points)

???
How to measure *size of win* based on vote shares?

---


# Winning categories

First we figure out *by how much* Republicans won (or lost) to Democrats in a county (this is called the **margin**): 

--

```{r, echo = TRUE, eval = TRUE}
elections_margin = elections %>% 
  mutate(reps_margin = per_gop_2020 - per_dem_2020) #<<
```


```{r, echo = FALSE, eval = TRUE}
elections %>% 
  select(state, name, per_gop_2020, per_dem_2020) %>% 
  mutate(reps_margin = per_gop_2020 - per_dem_2020)
```


---


# Winning categories

Now we can use `case_when()` to build categories out of the margin variable. 


`case_when()` uses the following formula: `LOGICAL CONDITION ~ "category name"`

--

Like so:


```{r, echo = TRUE}
elec_win_cat = elections_margin %>% 
  mutate(win_type = case_when(reps_margin >= .10 ~ "Big R win")) # reps win by more than 10
```

```{r, echo = FALSE, eval = TRUE}
elec_win_cat %>% 
  select(name, state, reps_margin, win_type)
```

---


# Winning categories

The rest of the categories:

```{r, echo = TRUE}
elec_win_cat = elections_margin %>% 
  mutate(win_type = case_when(reps_margin >= .10 ~ "Big R win", # reps win by more than 10
                              reps_margin > 0 & reps_margin < .1 ~ "Small R win", # reps win by more than 0 but less than 10
                              reps_margin < 0 & reps_margin > -.10 ~ "Small R loss", # reps lose by more than 0 but less than 10
                              reps_margin <= -.10 ~ "Big R loss")) # reps lose by more than 10
```

```{r, echo = FALSE, eval = TRUE}
elec_win_cat %>% 
  select(name, state, reps_margin, win_type)
```

---


# Make a plot

```{r, echo = TRUE}
ggplot(elec_win_cat, aes(x = per_gop_2020, fill = win_type)) + 
  geom_histogram() + theme_light()
```

---


# 🚨 Your turn 🚨

Using the `elections` dataset:


1. Using the variable on the percent of the county population that is Black/African-American, categorize the counties by whether the population is: 0-9% Black, 10-19% Black, 20-49% Black, or more than 50% Black. 

2. Make a boxplot (`geom_boxplot()`) where you put the new variable on the x-axis, and the Democrat vote share in the 2016 election on the y-axis. 