---
title: "Causality II"
subtitle: "The Scientific Study of Politics"  
author: 
  - "Juan Tellez"
date: '`r Sys.Date()`'
output:
  xaringan::moon_reader:
    lib_dir: "libs"
    css: ["default", "css/my-theme.css", "css/ath-inferno-fonts.css"]
    seal: false
    nature:
      highlightStyle: github
      highlightLanguage: ["r"]
      highlightLines: true
      highlightSpans: true
      countIncrementalSlides: false
      ratio: "16:9"
      navigation:
        scroll: false
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
knitr::opts_chunk$set(
  fig.width=9, 
  fig.height=3.5, 
  fig.retina=3,
  out.width = "100%",
  cache = FALSE,
  echo = FALSE,
  message = FALSE, 
  warning = FALSE,
  hiline = TRUE
)
```



```{r packages}
library(tidyverse)
library(ggdag)
library(rethinking)
library(broom)
data("WaffleDivorce")

# dubois colors
red = "#dc354a"
yellow = "#ecb025"
blue = "#213772"

# fancy theme
theme_fancy <- theme_bw(base_family = "Fira Sans", base_size = 14)


# set seed
set.seed(1990)

```



class: left, middle
background-image: url("images/dubois-spiral-2.png")
background-position: right
background-size: contain

# `r rmarkdown::metadata$title`

### *`r rmarkdown::metadata$subtitle`*

### Professor `r rmarkdown::metadata$author` 

#### University of California, Davis

---


class: center
.large[
# Today's agenda
]

--
.box-1.large.sp-after[DAGs]

--
.box-2.large.sp-after[Waffles and Divorce]

--
.box-3.large.sp-after[Elemental Confounds]

---


class: center, middle, inverse
# Last class

--


We want to know if X **causes** Y, using data

--


We *can* use models to capture the effect of X on Y, if in fact X does affect Y

--


Problem is some correlations are causal, others aren't

--

How can we tell?


---


# Causal diagram

.pull-left[
We need a *causal diagram* to get at causality


The diagram is our idea of the data came to be (the **data-generating process**)


The diagram tells us how to *identify* a causal effect (if it's possible!)

]

.pull-right[
```{r}
knitr::include_graphics("images/models.jpeg")
```
]

---


# Directed acyclical graphs (DAGs)


Nodes = variables; Arrows = direction of *causality*

--

```{r,out.width="80%"}
dagify(Y ~ X1) %>% 
  ggdag() + theme_dag()
```


X1 has an effect on Y

---


# DAGs



```{r, out.width = "80%"}
dagify(Y ~ X1, 
       X1 ~ X2) %>% 
  ggdag() + theme_dag()
```

--

X1 has an effect on Y; X2 has an effect on X1; X2 does not affect Y

---


# DAGs


```{r, out.width="80%"}
dagify(Y ~ X1 + X3, 
       X1 ~ X2 + X3) %>% 
  ggdag() + theme_dag()
```

--


X1 has an effect on Y; X2 has an effect on X1 and Y (via X1); X3 has an effect on X1 and Y


---


# Example: ideology


Where does (liberal) ideology come from?

--

Variables in the literature: Income (I), Liberal (L), Age (A), Media (M), Parents (P)

--


```{r}
dag = dagify(L ~ M + P + A + I, 
             M ~ P, 
             exposure = "M", 
             outcome = "L")
ggdag(dag) + theme_dag() + theme(legend.position = "none")
```

???
What are our assumptions? What's this DAG saying?


---

class: middle, center
# DAGs

DAGs encode everything we know about some process

--


We can see all of our assumptions and how they fit together

--


For example: the effect of Parents on how Liberal someone is happens *directly* and *indirectly* (through Media)

--

Missing arrows also matter: we are assuming that Age has *no effect* on Media diet


---


# ðŸš¨ Our turn: let's make our own DAG ðŸš¨


On [daggity.net](http://www.dagitty.net/dags.html#) about civil war

---


# Identification


DAGs are important because they help us figure out how to estimate the effect of one variable on another

--

While at the same time being mindful of all the other variables that we need to **adjust**, or **control**

--


For instance, we might want to estimate the effect of Media consumption (M) on how Liberal (L) someone is

--


This process is called "identification" $\rightarrow$ to **identify** the effect of X on Y


---


class: center, middle, inverse
# Waffles and Divorce
---



# Waffle House 


```{r}
knitr::include_graphics("images/waffle-house.png")
```



---


# Waffle House Index

.pull-left[
```{r}
knitr::include_graphics("images/waffle-house-index.jpeg")
```

]

--


.pull-right[
```{r}
knitr::include_graphics("images/waffle-index.png")
```

]



---


# Does Waffle House cause divorce?

--


States with many Waffle Houses per person also have some of the highest divorce rate

--

```{r}
WaffleDivorce %>% 
  mutate(`Waffles per Person` = WaffleHouses/Population) %>% 
  select(Location, Marriage, Divorce, `Waffles per Person`) %>% 
  knitr::kable(digits = 2)
```

---


# Does Waffle House cause divorce?


Do cheap, delicious waffles put marriages at risk? 

--

```{r}
ggplot(WaffleDivorce, aes(x = WaffleHouses/Population, y = Divorce)) + 
  geom_point(size = 3, fill = red, alpha = .8, shape = 21, color = "white") + 
  geom_smooth(method = "lm", color = red, fill = red) + 
  theme_fancy + 
  labs(x = "Waffle Houses per million residents", 
       y = "Divorce rate per 1,000 adults")
```


---


# Does Waffle House cause divorce?


Almost certainly *not*

--

No one thinks there is a *plausible* way in which Waffle House causes divorce

--

Instead, when we see a correlation of this kind we wonder about other variables that are "*actually*" driving the relationship

--

You've likely thought about this before: *a "lurking" variable, "other factors", that "matter"*

--

But what might that *variable* be? And *how* exactly does it lead us astray?


---


# The lurking variable


It turns out that Waffle Houses originated in the South (Georgia), and most of them are still there

--

The South also happens to have some of the highest divorce rates in the country

---


# The DAG


So the DAG might look something like this: South **has an effect on** Waffle Houses and Divorce, but Waffles **do not cause** Divorce


```{r, out.width="80%"}
dagify(Divorce ~ South, 
       Waffle ~ South, 
       exposure = "Waffle",
       outcome = "Divorce", 
       coords = list(x = c(Waffle = 0, Divorce = 2, South = 1), 
                      y = c(Waffle = 0, Divorce = 0, South = 1))) %>% 
  ggdag_status(text = FALSE, use_labels = "name") + theme_dag_blank() + 
  theme(legend.position = "none")
```

---


# The problem


```{r, out.width="60%"}
dagify(Divorce ~ South, 
       Waffle ~ South, 
       exposure = "Waffle",
       outcome = "Divorce", 
       coords = list(x = c(Waffle = 0, Divorce = 2, South = 1), 
                      y = c(Waffle = 0, Divorce = 0, South = 1))) %>% 
  ggdag_status(text = FALSE, use_labels = "name") + theme_dag_blank() + 
  theme(legend.position = "none")
```

--


A DAG like this will produce a *correlation* between Waffles and Divorce, even when there is no **causal** relationship

--


This is called **confounding**: the South is **confounding** the relationship between Waffles and Divorce


---


# Simulation to convince ourselves


Let's make up data to convince ourselves this is true

--

fifty states, about half of them are in the South in this made-up example

--

```{r, echo  = TRUE}
tibble(south = sample(c(0, 1), size = 50, replace = TRUE))
```

---


# Simulation to convince ourselves


Step 2: make Waffle houses, which are more **common** in the South

```{r, echo = TRUE}
tibble(south = sample(c(0, 1), size = 50, replace = TRUE), 
       waffle = rnorm(n = 50, mean = 20, sd = 4) + 10*south) #<<
```

---


# Simulation to convince ourselves


Step 3: make a divorce rate, which is **higher** in the South

```{r, echo = TRUE}
fake = tibble(south = sample(c(0, 1), size = 50, replace = TRUE), 
              waffle = rnorm(n = 50, mean = 20, sd = 4) + 10*south,
              divorce = rnorm(n = 50, mean = 20, sd = 2) + 8*south) #<<
```


Notice! Waffles do not **cause** divorce

---


# A totally spurious relationship


The South's **effect** on Waffle House and on Divorce creates a **spurious** correlation between the two


```{r}
ggplot(fake, aes(x = waffle, y = divorce)) + 
  geom_point(size = 3, fill = red, alpha = .8, shape = 21, color = "white") + 
  geom_smooth(method = "lm", color = red, fill = red) + 
  theme_fancy + 
  labs(title = "Our fake waffle data", 
       x = "Waffle Houses per million residents", 
       y = "Divorce rate per 1,000 adults")
```


---




# A totally spurious relationship


The DAG on the left will produce an association like the one on the right

.pull-left[
```{r}
dagify(Divorce ~ South, 
       Waffle ~ South, 
       exposure = "Waffle",
       outcome = "Divorce", 
       coords = list(x = c(Waffle = 0, Divorce = 2, South = 1), 
                      y = c(Waffle = 0, Divorce = 0, South = 1))) %>% 
  ggdag_status(text = FALSE, use_labels = "name") + theme_dag_blank() + 
  theme(legend.position = "none")
```
]


.pull-right[
```{r}
ggplot(fake, aes(x = waffle, y = divorce)) + 
  geom_point(size = 3, fill = red, alpha = .8, shape = 21, color = "white") + 
  geom_smooth(method = "lm", color = red, fill = red) + 
  theme_fancy + 
  labs(title = "Our fake waffle data", 
       x = "Waffle Houses per million residents", 
       y = "Divorce rate per 1,000 adults")
```
]


Even if Waffles and Divorce are **causally** unrelated

---


# ðŸš¨ Your turn: make a spurious correlation ðŸš¨


Using code like this:

```{r, echo = TRUE, eval = FALSE}
tibble(south = sample(c(0, 1), size = 50, replace = TRUE), 
              waffle = rnorm(n = 50, mean = 20, sd = 4) + 10*south,
              divorce = rnorm(n = 50, mean = 20, sd = 2) + 8*south)
```


Make your own spurious correlation by changing the names and values of the variables, where the effect of X on Y is totally the result of some third variable, Z. Plot it and throw it in the Slack. 



```{r}
countdown::countdown(minutes = 8L)
```



---




# What's going on here? 


.pull-left[
Think of causality as water flowing through the DAG, flowing in the direction of the arrows


We want look at water flowing **directly** from a **treatment** to an **outcome**

But **account** for the fact that there is often *indirect* flows that *contaminate* our estimates


]

.pull-right[
```{r}
knitr::include_graphics("images/mario-pipes.jpg")
```

]


---


# What's going on here?



To **identify** the effect of Waffles on Divorce we need to **account**, or **control for**, the indirect flow resulting from South

Otherwise we will be *confounded*



```{r, out.width="80%"}
dagify(Divorce ~ South, 
       Waffle ~ South, 
       exposure = "Waffle",
       outcome = "Divorce", 
       coords = list(x = c(Waffle = 0, Divorce = 2, South = 1), 
                      y = c(Waffle = 0, Divorce = 0, South = 1))) %>% 
  ggdag_status(text = FALSE, use_labels = "name") + theme_dag_blank() + 
  theme(legend.position = "none")
```

---


# The formula


1. Make a DAG of what we think is going on with our treatment and outcome

2. Figure out where the *indirect flows* are

3. Account for those in our analysis


---


# What do we need to control? 


```{r}
dagify(Y ~ X, 
       exposure = "X", 
       outcome = "Y") %>% 
  ggdag_status() + theme_dag_blank() + theme(legend.position = "none")
```

--

Nothing

---


# What do we need to control? 


```{r}
dagify(Y ~ X + Z, 
       exposure = "X", 
       outcome = "Y") %>% 
  ggdag_status() + theme_dag_blank() + theme(legend.position = "none")
```

--

Nothing! No indirect flow to X

---

# What do we need to control? 


```{r}
dagify(Y ~ X + Z + A + B, 
       X ~ G + H + J + K, 
       exposure = "X", 
       outcome = "Y") %>% 
  ggdag_status() + theme_dag_blank() + theme(legend.position = "none")
```

--

Nothing! No indirect flow to X!

---



# What do we need to control to identify...


Media consumption (M) $\rightarrow$ Liberal (L)


```{r}
dag = dagify(L ~ M + P + A + I, 
             M ~ P, 
             exposure = "M", 
             outcome = "L")
ggdag_status(dag) + theme_dag() + theme(legend.position = "none")
```

---




```{r,out.width="70%",fig.align='center'}
knitr::include_graphics("images/elemental-confounds.png")
```


---


# The confounding fork

Y $\leftarrow$ Z $\rightarrow$ X

--

There is a third variable, Z, that is a **common cause** of X and Y

--

```{r, out.width="90%"}
dagify(Y ~ Z, 
       X ~ Z, 
       exposure = "X",
       outcome = "Y", 
       coords = list(x = c(Y = 0, X = 2, Z = 1), 
                      y = c(Y = 0, X = 0, Z = 1))) %>% 
  ggdag() + theme_dag_blank() + 
  theme(legend.position = "none")
```


---

# The confounding fork


We've already seen this!


.pull-left[
```{r}
dagify(Divorce ~ South, 
       Waffle ~ South, 
       exposure = "Waffle",
       outcome = "Divorce", 
       coords = list(x = c(Waffle = 0, Divorce = 2, South = 1), 
                      y = c(Waffle = 0, Divorce = 0, South = 1))) %>% 
  ggdag_status(text = FALSE, use_labels = "name") + theme_dag_blank() + 
  theme(legend.position = "none")
```
]

.pull-right[
```{r}
dagify(Divorce ~ South + Waffle, 
       Waffle ~ South, 
       exposure = "Waffle",
       outcome = "Divorce", 
       coords = list(x = c(Waffle = 0, Divorce = 2, South = 1), 
                      y = c(Waffle = 0, Divorce = 0, South = 1))) %>% 
  ggdag_status(text = FALSE, use_labels = "name") + theme_dag_blank() + 
  theme(legend.position = "none")
```
]

But note that **both** of these fork scenarios will mess us up!


---


# The second scenario


Say that Waffles do cause Divorce, but the effect is tiny: .0001

```{r, echo = TRUE}
fake = tibble(south = sample(c(0, 1), size = 50, replace = TRUE), 
              waffle = rnorm(n = 50, mean = 20, sd = 4) + 10*south,
              divorce = rnorm(n = 50, mean = 20, sd = 2) + 8*south + .0001 * waffle) #<<
```


---

# The second scenario


The effect of Z (South) on X (Waffles) and Y (Divorce) will **distort** our estimates:

```{r, echo = TRUE}
lm(divorce ~ waffle, data = fake) %>% tidy()
```


--

Estimate is many, many times larger than the true effect

In some cases can even produce an opposite relationship!

---

# Dealing with forks


We need to figure out what Z is, measure it, and **adjust for it** in our analysis


```{r, out.width="90%"}
dagify(Y ~ Z, 
       X ~ Z, 
       exposure = "X",
       outcome = "Y", 
       coords = list(x = c(Y = 0, X = 2, Z = 1), 
                      y = c(Y = 0, X = 0, Z = 1))) %>% 
  ggdag_dseparated() + theme_dag_blank() + 
  theme(legend.position = "none")
```



---

# The perplexing pipe


X $\rightarrow$ Z $\rightarrow$ Y

X causes Z, which causes Y (or: Z *mediates* the effect of X on Y)

--


```{r, out.width="70%"}
dagify(Y ~ Z, 
       Z ~ X, 
       coords = list(x = c(X = -.5, Z = 0, Y = .5), 
                     y = c(Y = 0, Z = 0, X = 0))) %>% 
  ggdag() + theme_dag()
```


What happens if we **adjust for Z**?  We **block** the effect of X on Y; so we leave Z alone


---


# An example: foreign intervention


What effect does US foreign intervention have on US support abroad?

--

Say the DAG looks like this:

```{r, out.width = "70%"}
dagify(Sentiment ~ Infrastructure, 
       Infrastructure ~ Intervention, 
       exposure = "Intervention",
       outcome = "Sentiment", 
       coords = list(x = c(Intervention = -.5, Infrastructure = 0, 
                           Sentiment = 0), 
                     y = c(Sentiment = -.5, Infrastructure = 0, 
                           Intervention = 0))) %>% 
  ggdag_status(text = FALSE, use_labels = "name") + theme_dag() + 
  theme(legend.position = "none")
```


If we control for *Infrastructure* we are *blocking* the effect of intervention on support

---


# An example: foreign intervention


What if the DAG instead looked like this:

```{r}
dagify(Sentiment ~ Infrastructure + Intervention, 
       Infrastructure ~ Intervention, 
       exposure = "Intervention",
       outcome = "Sentiment", 
       coords = list(x = c(Intervention = -.5, Infrastructure = 0, 
                           Sentiment = 0), 
                     y = c(Sentiment = -.5, Infrastructure = 0, 
                           Intervention = 0))) %>% 
  ggdag_status(text = FALSE, use_labels = "name") + theme_dag() + 
  theme(legend.position = "none")
```

???
What does it mean

---


# An example: foreign intervention


Two ways that Intervention affects US sentiment: direclty and indirectly

Adjusting for **Infrastructure** blocks the *indirect* effect

So we are still **missing** part of the effect!


```{r, out.width="80%"}
dagify(Sentiment ~ Infrastructure + Intervention, 
       Infrastructure ~ Intervention, 
       exposure = "Intervention",
       outcome = "Sentiment", 
       coords = list(x = c(Intervention = -.5, Infrastructure = 0, 
                           Sentiment = 0), 
                     y = c(Sentiment = -.5, Infrastructure = 0, 
                           Intervention = 0))) %>% 
  ggdag_status(text = FALSE, use_labels = "name") + theme_dag() + 
  theme(legend.position = "none")
```

???
What does it mean

---


# Pipes: why are they even a problem?


Just leave pipes alone! It's a problem of "over-adjusting"

--

Bad social science: sometimes we are so afraid of **forks** that we control for everything we have data on

--

Especially when a process seems very complicated


---


# Example: where pipes go wrong


The effects of **smoking** on **heart problems** might be complex; lots of potential confounds to worry about

--


Researcher might think they need to control for a study subject's **cholesterol**

--

If the DAG looks like this, **cholesterol** is a pipe and controlling is bad!

--

```{r, out.width="80%"}
smoking_ca_dag = dagify(cardiacarrest ~ cholesterol,
                         cholesterol ~ smoking + weight,
                         smoking ~ unhealthy,
                         weight ~ unhealthy,
                         labels = c("cardiacarrest" = "Cardiac\n Arrest", 
                                    "smoking" = "Smoking",
                                    "cholesterol" = "Cholesterol",
                                    "unhealthy" = "Unhealthy\n Lifestyle",
                                    "weight" = "Weight"),
                         exposure = "smoking",
                         outcome = "cardiacarrest")

ggdag_status(smoking_ca_dag, text = FALSE, use_labels = "label") + theme_dag_blank() + theme(legend.position = "none")
```




---

# The explosive collider

$X \rightarrow Z \leftarrow Y$

--

X and Y have a common **effect**

--

Left alone, it's no problem; but **controlling for Z** creates strange patterns

--


```{r, out.width="70%"}
collider_triangle(x = "X", y = "Y", m = "Z") %>% 
  ggdag(use_labels = "label", text = FALSE) + theme_dag()
```


---

# Example: the NBA


```{r,out.width="50%"}
knitr::include_graphics("images/nba-height.png")
```

--


Should the NBA stop worrying about height when drafting players? 


---


# No!


Obviously, height helps in basketball

--

But **among NBA players** there might be no relationship between height and scoring, because shorter players have other advantages

--

**Among NBA players** = adjusting, or controlling for, being in the NBA

--

```{r, out.width="70%"}
dagify(Scoring ~ Height, 
       NBA ~ Scoring + Height, 
       exposure = "Height", 
       outcome = "Scoring",
       coords = list(x = c(Height = -.5, NBA = 0, Scoring = .5), 
                     y = c(Height = 0, NBA = -.5, Scoring = 0))) %>% 
  ggdag_status(text = FALSE, use_labels = "name") + 
  theme_dag() + theme(legend.position = "none")
```




---


# Another example: bad findings

Richard McElreath asks: why are surprising findings so often untrustworthy? 

--

```{r,out.width="60%"}
knitr::include_graphics("images/hurricanes.png")
```


---

# Another example: bad findings


```{r, out.width="60%"}
knitr::include_graphics("images/shark-elections.png")
```


---


# It's a collider


Imagine that in the world there is no relationship between how **surprising** a finding is and how **trustworthy** it is

--

```{r}
# simulate fake study selection data
n = 200 # number of studies
p = 0.1 # proportion of studies that get chosen
df = tibble(newsworthy = rnorm(n), 
            trustworthy = rnorm(n), 
            total = newsworthy + trustworthy, 
            top10 = quantile(total, probs = 1 - p), 
            published = ifelse(total >= top10, TRUE, FALSE))



ggplot(df, aes(x = newsworthy, y = trustworthy)) + 
  geom_point(size = 3, fill = red, alpha = .8, shape = 21, color = "white") + 
  theme_fancy +
  labs(x = "How Surprising the Study is", 
       y = "How Trustworthy the Study is") + 
  theme(legend.position = "none")

```


---


# It's a collider


But now imagine that studies are only published **either** if they're *very trustworthy* OR *very surprising*


```{r}
ggplot(df, aes(x = newsworthy, y = trustworthy, fill = published)) + 
  geom_point(size = 3, alpha = .8, shape = 21, color = "white") + 
  theme_fancy +
  labs(x = "How Surprising the Study is", 
       y = "How Trustworthy the Study is") + 
  scale_fill_manual(values = c(red, blue)) + 
  theme(legend.position = "top")
```


---


# It's a collider


By only looking at *published papers* (e.g., **controlling for publication**), we create a negative relationship that doesn't exist


```{r}
ggplot(df, aes(x = newsworthy, y = trustworthy, fill = published)) + 
  geom_point(size = 3, alpha = .8, shape = 21, color = "white") + 
  theme_fancy +
  labs(x = "How Surprising the Study is", 
       y = "How Trustworthy the Study is") + 
  scale_fill_manual(values = c(red, blue)) + 
  theme(legend.position = "top") + 
  geom_smooth(method = "lm")
```


---


# Exploding colliders


Like pipes, colliders are a problem of controlling for the wrong thing

They are often the result of a **sample selection** problem

They can **obscure** actual relationships or **fabricate** non-existent ones

We need to avoid controlling for colliders; but they are everywhere!


.pull-left[
```{r}
dagify(Scoring ~ Height, 
       NBA ~ Scoring + Height, 
       exposure = "Height", 
       outcome = "Scoring",
       coords = list(x = c(Height = -.5, NBA = 0, Scoring = .5), 
                     y = c(Height = 0, NBA = -.5, Scoring = 0))) %>% 
  ggdag_status(text = FALSE, use_labels = "name") + 
  theme_dag() + theme(legend.position = "none")
```
]


.pull-right[
```{r}
dagify(Published ~ Trustworth + Surprising, 
       exposure = "Surprising", 
       outcome = "Trustworth",
       coords = list(x = c(Surprising = -.5, Published = 0, Trustworth = .5), 
                     y = c(Surprising = 0, Published = -.5, Trustworth = 0))) %>% 
  ggdag_status(text = FALSE, use_labels = "name") + 
  theme_dag() + theme(legend.position = "none")
```
]


---


# Extra slides
---


# A totally spurious relationship


Divorce is **higher** in the South; so are Waffles


```{r}
ggplot(fake, aes(x = waffle, y = divorce, fill = factor(south))) + 
  geom_point(size = 3, alpha = .8, shape = 21, color = "white") + 
  theme_fancy + 
  labs(title = "Our fake waffle data", 
       x = "Waffle Houses per million residents", 
       y = "Divorce rate per 1,000 adults", 
       fill = "Region:") + 
  scale_fill_manual(values = c(red, blue), labels = c("Not South", 
                                                      "South")) + 
  theme(legend.position = "top")
```


---
